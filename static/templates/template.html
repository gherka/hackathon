{#  JINJA2 MACROS aka FUNCTIONS:  #}

{% macro diff(a, b, col) %}
{#  for some reason comparing macro string output with a string fails   #}
    
    {% if a == b %}
        {{ 1 }}
    
    {% elif a != b and (col == 'Format' or col == 'Breaks?' or col == 'Frequency') %}
        {{ 0 }}

    {% elif a > b %}
        {{ 2 }}

    {% elif a < b  %}
        {{ 3 }}

    {% endif %}

{% endmacro %}

<!DOCTYPE html>

<html>

<head>
    <!-- Three mandatory meta tags when using Bootstrap -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/main.css">
    <title>Dataset comparison report</title>
</head>

<body>

<div class="container" style="max-width: 1000px;">

    <!-- Title across the entire container -->
    <div style="text-align: center;">
        <h1>Visual report comparing two datasets</h1>
        <p><i>Built using Seaborn, Bootstrap and Jinja2 templates</i></p>
    </div>

    <!-- Summary text -->
    <div>
        <h4>What can we tell you about these two datasets?</h4>
    </div>

    <!-- Summary tables with number of rows and columns in each dataset -->
    <div class="d-flex">
        <div class="row">
            {% for df in summary['DFs'] %}
            <div class="col-md-6">
            <table>
                <TR>
                    <TD class="table_top" colspan="2">{{ df }}</TD>
                </TR>
                <TR>
                    <TD class="table_top file_name" colspan="2">{{ summary['DFs'][df]['file_name'] }}</TD>
                </TR>
                <TR>
                    <TD>Number of rows</TD>
                    <TD>Number of columns</TD>
                </TR>
                <TR>
                    <TD>{{ summary['DFs'][df]['shape'][0] }}</TD>
                    <TD>{{ summary['DFs'][df]['shape'][1] }}</TD>
                </TR>
            </table>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Mismatching columns -->
    <div>
        <h5 class="py-4 col-md-9" style="text-align: left"><u>Mismatching</u> variable names:</h5>
        <ul>
            {% for item in summary['Metadata']['diff_vars'] %}

                <li style="font-size: 18px">

                {% if item|length == 2 %}
                    {{ item[0] }} - only in {{ item[1] }}
                {% else %}
                    {{ item }}
                {% endif %}
                
                </li>

            {% endfor %}
        </ul>
    </div>

    <!-- Detailed tables generator -->
    <div>
    <!-- Create a table for each var_type: Categorical, Continuous, Timeseries -->
    {% for var_type in summary['Metadata']['common_vars'].keys() %}

    <h5 class="py-2 col-md-12" style="text-align: center">{{var_type}} variables</h5>

    <div class="row">
            <div class="col-md-12">
            <table class="table">
                <thead>
                    <TR>
                        <TD class="table_top" style="text-align: left">Variable Name</TD>
                        <TD class="table_top" style="text-align: left"></TD>
                        <!-- Since columns might differ depending on var_type, they are generated in their own loop -->
                        {% for col_name in summary['Metadata']['table_columns'][var_type] %}
                        <TD class="table_top" style=>{{ col_name }}</TD>
                        {% endfor %}

                    </TR>
                </thead>
                <tbody>
                    <!-- Each row in the table corresponds to a variable in the dataset; rows are also generated in a loop -->
                    {% for var_name in summary['Metadata']['common_vars'][var_type].keys() %}
                        <!-- Save the long dict path to an internal Jinja variable for clarity -->
                        {% set root_dict = summary['Metadata']['common_vars'][var_type][var_name]['DFs'] %}
                        <TR>
                            <TR  class="{{ loop.cycle('odd', 'even') }}">
                                <TD class="align-middle" style="text-align: left; width:15%;" rowspan="4">{{ var_name }}</TD>
                                <TD class="align-middle" style="width:10%;" rowspan="2">DF1</TD>
                                <!-- Since we don't know how many columns each var_type has, we need another loop -->
                                {% for col_name in summary['Metadata']['table_columns'][var_type] %}
                                    <TD class= "align-middle">
                                        {{ root_dict['DF1'][col_name] }}
                                    </TD>
                                {% endfor %}
                            </TR>

                            <TR class="{{ loop.cycle('odd', 'even') }}">
                                {% for col_name in summary['Metadata']['table_columns'][var_type] %}

                                    {% set diff_output = diff(root_dict['DF1'][col_name], root_dict['DF2'][col_name], col_name) %}
                                        
                                        {% if diff_output|int == 1 %}
                                        
                                        {{ '<TD class="align-middle" rowspan="2">Same</TD>' }}

                                        {% elif diff_output|int == 0 %}

                                        {{ '<TD class="align-middle diff_highlight_time" rowspan="2">Different</TD>' }}
                                        
                                        {% elif diff_output|int == 2  %}

                                        {{ '<TD class="align-middle diff_highlight_greater" rowspan="2">Greater Than > </TD>' }}

                                        {% elif diff_output|int == 3  %}

                                        {{ '<TD class="align-middle diff_highlight_less" rowspan="2">Less Than < </TD>' }}



                                        {% endif %}
  
                                {% endfor %}
                            </TR>

                            <TR class="{{ loop.cycle('odd', 'even') }}">
                                <TD class="align-middle" style="width:10%;" rowspan="2">DF2</TD>

                            </TR>

                            <TR class="{{ loop.cycle('odd', 'even') }}">
                                {% for col_name in summary['Metadata']['table_columns'][var_type] %}
                                    <TD class= "align-middle">
                                            {{ root_dict['DF2'][col_name] }}
                                    </TD>
                                {% endfor %}
                            </TR>
                    </TR>
                    <!-- Extra row to act as a separator -->
                    <TR style="height:1px"></TR>

                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endfor %}

    </div>

    <!-- Plot headline text -->
    <div>
        <h4>Okay, but how do they actually look like. In person, you know?</h4>
        <p><i>Cross-hatching indicates differences between two datasets</i></p>
    </div>

    <!-- Plots -->
    <div class="row">
        <div class= "d-flex align-content-start">
        <div class="col-md-6" style="text-align: center;">
            <p>Here's the first dataset</p>
            <img src="static/images/image_1.png" class="img-fluid"/></div>
        <div class="col-md-6" style="text-align: center;">
            <p>Here's the second dataset</p>
            <img src="static/images/image_2.png" class="img-fluid"/></div>
        </div>
    </div>

</div>

</body>
</html>