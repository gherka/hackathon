{#  JINJA2 MACROS aka FUNCTIONS:  #}

{% macro diff(a, b, col) %}
{#  for some reason comparing macro string output with a string fails   #}
    
    {% if a == b %}
        {{ 1 }}
    
    {% elif a != b and (col == 'Format' or col == 'Breaks?' or col == 'Frequency') %}
        {{ 0 }}

    {% elif a > b %}
        {{ 2 }}

    {% elif a < b  %}
        {{ 3 }}

    {% endif %}

{% endmacro %}

<!DOCTYPE html>

<html>

<head>
    <!-- Three mandatory meta tags when using Bootstrap -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/main.css">
    <link rel="stylesheet" href="static/css/bokeh-1.1.0.min.css">

    <title>Dataset comparison report</title>
</head>

<body>

<div class="container" style="max-width: 1000px;">

    <!-- Title across the entire container -->
    <div style="text-align: center;">
        <h1>Visual report comparing two datasets</h1>
        <p><i>Built using Bokeh, Bootstrap and Jinja2 templates</i></p>
    </div>

    <!-- Summary text -->
    <div>
        <h4>Summary information and dataset shapes:</h4>
    </div>

    <!-- Summary tables with number of rows and columns in each dataset -->
    <div class="d-flex">
        <div class="row">
            {% for df in summary['DFs'] %}
            <div class="col-md-6">
            <table>
                <TR>
                    <TD class="table_top" colspan="2">{{ df }}</TD>
                </TR>
                <TR>
                    <TD class="table_top file_name" colspan="2">{{ summary['DFs'][df]['file_name'] }}</TD>
                </TR>
                <TR>
                    <TD>Number of rows</TD>
                    <TD>Number of columns</TD>
                </TR>
                <TR>
                    <TD>{{ summary['DFs'][df]['shape'][0] }}</TD>
                    <TD>{{ summary['DFs'][df]['shape'][1] }}</TD>
                </TR>
            </table>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Mismatching columns -->
    <div>
        <h4 class="py-4" style="text-align: left"><u>Mismatching</u> variable names:</h5>
        <ul>
            {% for item in summary['Metadata']['different_columns'] %}

                <li style="font-size: 18px">

                {% if item|length == 2 %}
                    {{ item[0] }} - only in {{ item[1] }}
                {% else %}
                    {{ item }}
                {% endif %}
                
                </li>

            {% endfor %}
        </ul>
    </div>

    <!-- Detailed tables generator -->
    <div>
    <!-- Create a table for each column dtype: Categorical, Continuous, Timeseries -->
    {% for col_dtype in summary['Metadata']['common_columns'].keys() %}

    <h5 class="py-2 col-md-12" style="text-align: center">{{col_dtype}} variables</h5>

    <div class="row">
            <div class="col-md-12">
            <table class="table">
                <thead>
                    <TR>
                        <TD class="table_top" style="text-align: left">Variable Name</TD>
                        <TD class="table_top" style="text-align: left"></TD>
                        <!-- Since columns might differ depending on column dtype, they are generated in their own loop -->
                        {% for col_name in summary['Metadata']['table_columns'][col_dtype] %}
                        <TD class="table_top" style=>{{ col_name }}</TD>
                        {% endfor %}

                        {% if col_dtype =='Categorical' %}

                            <TD class="table_top" style="text-align: center">Frequencies Plot</TD>

                        {% elif col_dtype == 'Continuous' %}

                            <TD class="table_top" style="text-align: center">KDE Distribution Plot</TD>

                        {% endif %}

                    </TR>
                </thead>
                <tbody>
                    <!-- Each row in the table corresponds to a variable in the dataset; rows are also generated in a loop -->
                    {% for col_name in summary['Metadata']['common_columns'][col_dtype].keys() %}
                        <!-- Save the long dict path to an internal Jinja variable for clarity -->
                        {% set root_dict = summary['Metadata']['common_columns'][col_dtype][col_name]['DFs'] %}

                            <TR  class="{{ loop.cycle('fixed_height_row odd', 'fixed_height_row even') }}">
                                <TD class="align-middle" style="text-align: left; width:15%;" rowspan="4">{{ col_name }}</TD>
                                <TD class="align-middle" style="width:10%;" rowspan="2">DF1</TD>
                                <!-- Since we don't know how many columns each column dtype has, we need another loop -->
                                {% for col_name in summary['Metadata']['table_columns'][col_dtype] %}
                                    <TD class= "align-middle">
                                        {{ root_dict['DF1'][col_name] }}
                                    </TD>
                                {% endfor %}

                                {% if col_dtype == 'Continuous' %}

                                    <TD class="align-middle" id="kde_{{col_name}}" style="width:20%;" rowspan="4">
                                    </TD>

                                {%  elif col_dtype == 'Categorical' %}

                                    <TD class="align-middle" id="cat_{{col_name}}" style="width:20%;" rowspan="4">
                                    </TD>
                                                            
                                {% endif %}

                            </TR>

                            <TR class="{{ loop.cycle('fixed_height_row odd', 'fixed_height_row even') }}">
                                {% for col_name in summary['Metadata']['table_columns'][col_dtype] %}

                                    {% set diff_output = diff(root_dict['DF1'][col_name], root_dict['DF2'][col_name], col_name) %}
                                        
                                        {% if diff_output|int == 1 %}
                                        
                                        {{ '<TD class="align-middle" rowspan="2">Same</TD>' }}

                                        {% elif diff_output|int == 0 %}

                                        {{ '<TD class="align-middle diff_highlight_time" rowspan="2">Different</TD>' }}
                                        
                                        {% elif diff_output|int == 2  %}

                                        {{ '<TD class="align-middle diff_highlight_greater" rowspan="2">Greater</TD>' }}

                                        {% elif diff_output|int == 3  %}

                                        {{ '<TD class="align-middle diff_highlight_less" rowspan="2">Less</TD>' }}



                                        {% endif %}
  
                                {% endfor %}
                            </TR>

                            <TR class="{{ loop.cycle('fixed_height_row odd', 'fixed_height_row even') }}">
                                
                                <TD class="align-middle" style="width:10%;" rowspan="2">DF2</TD>

                            </TR>

                            <TR class="{{ loop.cycle('fixed_height_row odd', 'fixed_height_row even') }}">
                                {% for col_name in summary['Metadata']['table_columns'][col_dtype] %}
                                    <TD class= "align-middle">
                                            {{ root_dict['DF2'][col_name] }}
                                    </TD>
                                {% endfor %}
                            </TR>
                    <!-- Extra row to act as a separator -->
                    <TR style="height:1px"></TR>

                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endfor %}

    </div>

    <!-- Ridge Plot section-->

    {% if ridge_plot is not none  %}

    {{
    '<div style="text-align: center">'
        '<h5>Ridge plot showing 5 combinations with the most different distributions</h5>'
        '<i>Click on a legend item to toggle the visibility of plot elements</i>'
    '</div>'
    '<div id="ridge_plot_id"></div>'
    }}

    {% endif %}

</div>

<script src="static/scripts/bokeh-1.1.0.min.js"></script>
<script> 
// Use BokehJS to rended frequency difference plots from their JSON representation
{% for v in summary['Metadata']['common_columns']['Categorical'].keys() %}

    var item = JSON.parse('{{cat_plots[v]}}');
    Bokeh.embed.embed_item(item, 'cat_{{v}}');

{% endfor %}

</script>


<script> 
// Use BokehJS to rended KDE plots from their JSON representation
{% for v in summary['Metadata']['common_columns']['Continuous'].keys() %}

    var item = JSON.parse('{{kde_plots[v]}}');
    Bokeh.embed.embed_item(item, 'kde_{{v}}');

{% endfor %}

</script>

<script> 
// Use BokehJS to rended ridge plot from their JSON representation
var item = JSON.parse('{{ ridge_plot }}');
Bokeh.embed.embed_item(item, 'ridge_plot_id');
</script>

</body>
</html>